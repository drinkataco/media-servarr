name: Release Charts

on:
  push:
    branches:
      - 'feature/RethinkCICD'
    paths:
      - 'charts/**/Chart.yaml'

jobs:
  release:
    permissions:
      contents: 'write' # to push chart release and create a release (helm/chart-releaser-action)

    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout Code'
        uses: 'actions/checkout@v4'

      - name: 'Fetch history'
        run: 'git fetch --prune --unshallow'

      - name: 'Configure Git'
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: 'Set up Helm'
        uses: 'azure/setup-helm@v3.5'
        with:
          version: 'v3.12.0'

      - name: 'Prepare packaging'
        run: |
          #!/bin/sh
          # Fetch current index.yaml
          CR_INDEX_DIR=.cr-index
          mkdir "$CR_INDEX_DIR"
          make pre-fetch DIST="$CR_INDEX_DIR"

          # prepare destination directory
          PACKAGE_PATH='./dist/charts'
          echo "PACKAGE_PATH=${PACKAGE_PATH}" >> $GITHUB_ENV
          mkdir -p "${PACKAGE_PATH}"

      - name: 'Run chart-releaser'
        uses: 'helm/chart-releaser-action@6203d709ca237fb26b724837f2c53716f244ee8c'
        with:
          skip_upload: true
          package-path:
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_GENERATE_RELEASE_NOTES: true

      - name: 'List'
        run: |
          ls -R .

      # - name: 'Upload to S3'

