name: 'Package and Release Helm Charts'

on:
  push:
    branches:
      - 'feature/RethinkCICD'
    paths:
      - 'chart/**/Chart.yaml'

jobs:
  package-and-release:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v2'

      - name: 'Set up Helm'
        uses: 'azure/setup-helm@v1'
        with:
          version: '3.x'

      - name: 'Package Updated Charts'
        id: package
        run: |
          mkdir packaged-charts
          changed_charts=$(git diff --find-renames --name-only ${{ github.event.before }} ${{ github.sha }} 'chart/**/Chart.yaml' | sed -n 's#\(chart/.*/\)Chart.yaml#\1#p')
          for chart in $changed_charts; do
            chart_name=$(basename $chart)
            version=$(grep 'version:' $chart/Chart.yaml | awk '{print $2}')
            previous_version=$(git show ${{ github.event.before }}:$chart/Chart.yaml | grep 'version:' | awk '{print $2}')
            if [ "$version" != "$previous_version" ]; then
              helm package $chart -d packaged-charts
              echo "::set-output name=${chart_name}::packaged"
            else
              echo "${chart_name} version has not changed, skipping..."
            fi
          done

      - name: Create GitHub Release
        if: steps.package.outputs
        uses: softprops/action-gh-release@v1
        with:
          files: packaged-charts/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
